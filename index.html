<!DOCTYPE html>
<!--
Copyright 2011 Seth Ladd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!-- 화면에 그리는 로직을 box2D에 맡기지 않은 예제 -->

<html>
  <head>
    <meta charset="utf-8">
    <title>Box2D Javascript Fun : 03 : Web Workers and Box2D</title>
    <link rel="author" href="http://profiles.heej.net">
		<style>
			body, html {
				margin: 0;
				padding: 0;
			}
			canvas { 
				width: 100%; 
				height: 100%;
			}
			#stats {
				position: fixed;
				top: 0;
				left: 0;
			}
		</style>
    <script src="./libs/Stats.js"></script>
    <script src="./libs/Three.js"></script>
  </head>
  <body>
    <script>
    // requestAnimFrame 관련 객체 가져오기 
    window.requestAnimFrame = (function(){
          return  window.requestAnimationFrame       || 
                  window.webkitRequestAnimationFrame || 
                  window.mozRequestAnimationFrame    || 
                  window.oRequestAnimationFrame      || 
                  window.msRequestAnimationFrame     || 
                  function(/* function */ callback, /* DOMElement */ element){
                    window.setTimeout(callback, 1000 / 60);
                  };
    })();
    </script>
    
    <script>
   	// 기생조합상속 메소드
	function inheritPrototype(subType, superType) {
		var prototype = Object.create(superType.prototype);
		prototype.constructor = subType;
		subType.prototype = prototype;
	}

    // 도형의 SuperType
    function Entity(id, x, y, z) {
      this.id = id;
	  this.renderRef = null;
      this.x = x;
      this.y = y;
      this.z = z;
      //this.angle = 0;
    }
    
    Entity.prototype.update = function(state) {
      this.x = state.x;
      this.y = state.y;
      this.z = state.z;
      //this.angle = state.a;
      
      this.renderRef.position.x = state.x;
      this.renderRef.position.y = state.y;
      this.renderRef.position.z = state.z;
    }    
    
    function SphereEntity(id, x, y, z, radius) {
      Entity.call(this, id, x, y, z);
      this.radius = radius;
    }
    inheritPrototype(SphereEntity, Entity);    
    
    function CubeEntity(id, x, y, z, halfWidth, halfHeight, halfDepth) {
      Entity.call(this, id, x, y, z);
      this.halfWidth = halfWidth;
      this.halfHeight = halfHeight;
      this.halfDepth = halfDepth;
    }
    inheritPrototype(CubeEntity, Entity);  
    
    // 화면에 그려주는 모듈
    function c3DebugDraw(world) {
    	this.world = world;
	    this.scene = new THREE.Scene();
		this.camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 100 );
		this.camera.position.x = 10; // 카메라 위치 세팅 
		this.camera.position.y = 2; // 카메라 위치 세팅 
		this.camera.position.z = 30; // 카메라 위치 세팅 
		
		this.init();
    }
    c3DebugDraw.prototype.init = function() {
    	// 렌더러 인스턴스를 만들고 canvas객체를 화면에 붙인다.
		this.renderer = new THREE.WebGLRenderer();
		this.renderer.setSize( window.innerWidth, window.innerHeight );
		this.renderer.setClearColor( 0x888888, 1 );

		// add subtle ambient lighting
		var ambientLight = new THREE.AmbientLight(0x222222);
		this.scene.add(ambientLight);
		
		// directional lighting
		var directionalLight = new THREE.DirectionalLight(0xffffff);
		directionalLight.position.set(5, 5, 5).normalize();
		this.scene.add(directionalLight);



		document.body.appendChild( this.renderer.domElement );
		
		// 초기 body의 정보를 scene에 추가한다.
		this.addEntitiesFromWorld();
    };
    c3DebugDraw.prototype.addEntitiesFromWorld = function() {
	    // world 내의 body들을 순회하면서 scene에 모두 추가시킨 후에 그리기를 수행한다.
		for (var id in this.world) {
			var entity = world[id];
			/*
			var center = {
				x : entity.position.x,
				y : entity.y,
				z : entity.z,
			};
			*/
			if(entity instanceof SphereEntity) {
//				this.AddSphere(entity, entity.radius, 0x00ff00);
				this.AddSphere(entity, entity.radius, Math.random()*16777215);

			}
			if(entity instanceof CubeEntity) {
//				this.AddCube(entity, entity.halfWidth, entity.halfHeight, entity.halfDepth , 0xff0000);
				this.AddCube(entity, entity.halfWidth, entity.halfHeight, entity.halfDepth , Math.random()*16777215);

			}
		}
    };      
    c3DebugDraw.prototype.AddSphere =  function (entity, radius, color) {
		if (!radius) return;
		var geometry = new THREE.SphereGeometry( radius, 8, 8 );
		var material = new THREE.MeshBasicMaterial( 
			{	
				color: color
		//		, wireframe: true
			} 
		);
var material = new THREE.MeshPhongMaterial({
        // light
        specular: '#a9fcff',
        // intermediate
        color: color,
        // dark
        emissive: '#006063',
        shininess: 50 
      });
		var sphere = new THREE.Mesh( geometry, material );
		
		sphere.position.x = entity.x;
		sphere.position.y = entity.y;
		sphere.position.z = entity.z;
				
		entity.renderRef = sphere;
      		
		this.scene.add( sphere );	    
    };
    c3DebugDraw.prototype.AddCube =  function (entity, halfWidth, halfHeight, halfDepth , color) {
		if (!halfWidth || !halfHeight || !halfDepth) return;
		var geometry = new THREE.BoxGeometry( 2*halfWidth , 2*halfHeight, 2*halfDepth); // 기하학적 모양 결정
		var material = new THREE.MeshBasicMaterial( 
			{	
				color: color
//				, wireframe: true
			} 
		);
var material = new THREE.MeshPhongMaterial({
        // light
        specular: '#a9fcff',
        // intermediate
        color: color,
        // dark
        emissive: '#006063',
        shininess: 100 
      });
      
		var cube = new THREE.Mesh( geometry, material ); // 해당 모양과 재질을 가진 물체 생성 
		cube.position.x = entity.x;
		cube.position.y = entity.y;
		cube.position.z = entity.z;
		
		entity.renderRef = cube;
		
		this.scene.add( cube ); // 물체를 장면에 추가	    
    };   
    c3DebugDraw.prototype.draw = function() { 
    	this.renderer.render(this.scene, this.camera); 
	};
	
	//// 예제를 위한 코드나 함수들 - 시작
    // 프레임 측정위젯 초기화및 Dom에 붙이기
    function randomEntity(id) {
      var x = Math.random() * 20;
      var y = Math.random() * 10;
      var z = Math.random() * 10 + 10;
           
      if (Math.random() > 0.5) {
        return new SphereEntity(id, x, y, z, Math.random() + 0.1);
      } else {
        return new CubeEntity(id, x, y, z, Math.random() + 0.1, Math.random() + 0.1, Math.random() + 0.1);
      }
    }
    
    var stats = new Stats();
    document.body.appendChild(stats.domElement);
	//// 예제를 위한 코드나 함수들 - 끝	
	
	//// 실제 main 흐름
    // 화면에 그리기 위해 필요한 정보만 딱 들어있는 객체들
    var world = {};
    for (var i = 0; i < 200; i++) {
      world[i] = randomEntity(i);
    }
    
    
    var worker = new Worker('physics.js');
    worker.postMessage(world);
    
    worker.onmessage = function(e) {
      for (var id in e.data) {
        var entity = world[id];
        if (entity) entity.update(e.data[id]);
      }
    };
    
	
    var drawer = new c3DebugDraw(world);
    (function loop() {
      drawer.draw();
      stats.update();
      requestAnimFrame(loop);
    })();
    </script>
  </body>
</html>
